name: Build Packages

on:
  push:
    branches:
      - master

permissions:
  contents: write

concurrency:
  group: packages
  cancel-in-progress: true

jobs:
  build-desktop:
    name: Build Desktop ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        shell: bash
        run: chmod +x gradlew

      - name: Build macOS DMG
        if: matrix.os == 'macos-latest'
        shell: bash
        run: ./gradlew :composeApp:packageDmg

      - name: Build Linux DEB and RPM
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: ./gradlew :composeApp:packageDeb :composeApp:packageRpm

      - name: Build Windows MSI
        if: matrix.os == 'windows-latest'
        shell: bash
        run: ./gradlew :composeApp:packageMsi

      - name: Collect desktop artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-assets

          if [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            dmg_file=$(find composeApp/build/compose/binaries/main/dmg -type f -name '*.dmg' | head -n 1)
            cp "$dmg_file" release-assets/hangman-macos.dmg
          fi

          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            deb_file=$(find composeApp/build/compose/binaries/main/deb -type f -name '*.deb' | head -n 1)
            rpm_file=$(find composeApp/build/compose/binaries/main/rpm -type f -name '*.rpm' | head -n 1)
            cp "$deb_file" release-assets/hangman-linux.deb
            cp "$rpm_file" release-assets/hangman-linux.rpm
          fi

          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            msi_file=$(find composeApp/build/compose/binaries/main/msi -type f -name '*.msi' | head -n 1)
            cp "$msi_file" release-assets/hangman-windows.msi
          fi

      - name: Upload desktop artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.os }}
          path: release-assets/*
          if-no-files-found: error

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        shell: bash
        run: chmod +x gradlew

      - name: Build release APK
        shell: bash
        run: ./gradlew :app:assembleRelease

      - name: Collect android artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-assets

          apk_file=$(find app/build/outputs/apk/release -type f -name '*.apk' | head -n 1)
          cp "$apk_file" release-assets/hangman-android.apk
          ls -la release-assets

      - name: Upload android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android
          path: release-assets/*
          if-no-files-found: error

  release-desktop:
    name: Publish Desktop Release
    runs-on: ubuntu-latest
    needs: build-desktop
    steps:
      - name: Download desktop artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: desktop-*
          path: collected

      - name: Flatten desktop artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-assets
          find collected -type f -exec cp {} release-assets/ \;
          ls -la release-assets

      - name: Create or update desktop release
        uses: ncipollo/release-action@v1
        with:
          tag: desktop-latest
          name: Desktop Packages (Latest)
          body: |
            Automatically generated desktop installers from the latest `master` commit.
          allowUpdates: true
          replacesArtifacts: true
          artifacts: "release-assets/hangman-macos.dmg,release-assets/hangman-windows.msi,release-assets/hangman-linux.deb,release-assets/hangman-linux.rpm"

  release-android:
    name: Publish Android Release
    runs-on: ubuntu-latest
    needs: build-android
    steps:
      - name: Download android artifacts
        uses: actions/download-artifact@v4
        with:
          name: android
          path: release-assets

      - name: List android artifacts
        shell: bash
        run: ls -la release-assets

      - name: Create or update android release
        uses: ncipollo/release-action@v1
        with:
          tag: android-latest
          name: Android Packages (Latest)
          body: |
            Automatically generated Android APK from the latest `master` commit.
          allowUpdates: true
          replacesArtifacts: true
          artifacts: "release-assets/hangman-android.apk"
